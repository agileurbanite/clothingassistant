<div id="search-bar">
	<div class="container">
            <div id="type_filter">
                <a href="#" class="<?php echo (empty($_SESSION['user']['type'])? 'hit': ''); ?>">All</a>
                <?php foreach($this->user['availableTypes'] as $type){ ?>
                    <a href="#" class="<?php if($type == $_SESSION['user']['type']){ echo 'hit'; } ?>"><?php echo ucfirst($type); ?></a>
                <?  } ?>
            </div>
            <ul id="active-filters">
                <?php foreach($this->users['brands'] as $brand){ ?>
                    <!-- <li class="<?php echo $brand; ?>"><span class="close"></span><?php echo $brand; ?></li> -->
                <? } ?>
            </ul>
            <div id="gender-toggle" class="right">
                <a href="/female" class="<?php if($_SESSION['user']['gender'] == 'f'){ echo "active"; } ?>" data-gender="f">Female</a>
                |
                <a href="/male" class="<?php if($_SESSION['user']['gender'] == 'm'){ echo "active"; } ?>" data-gender="m">Male</a>
            </div>    
		<!-- <div id="search" class="ui-widget">
			<form>
				<input type="text" name="query" id="query" placeholder="Add a Brand" />
			</form>
		</div> -->
	</div>
</div><!--#search-->

<div id="splash"></div>

<div class="indicator"></div>

<ul id="products">
<?php   foreach($this->products->rows() as $product){   ?>
<li class="col3" data-product_id="<?php echo $product['product_id']; ?>">
    <a href="<?php echo $product['product_url']; ?>" class="item" target="_blank">
            <img src="<?php echo $product['image_url']; ?>" alt="<?php echo htmlentities($product['title'],ENT_QUOTES, 'UTF-8');?>" />
            <div class="price">$<?php echo $product['price']; ?></div>
    </a>
    <div class="rating"></div>
    <span class="current-rating"><?php echo $product['like_count']; ?></span>
    <div data-prod_id="<?php echo $product['product_id']; ?>" class="like-button"></div>
</li>    
<?  }   ?>
</ul>

<div id="womens-styles-cont">
	<h1>Choose your style</h1> 
	<ul class="style-choices" id="womens-styles">
		<li class="All">
			<img src="/img/women-1.jpg" alt="All Brands" />
			<div class="btn-container"><button class="gray-large">All Styles</button></div>
		</li>
		<li class="Random">
			<img src="/img/halloween/style-woman-random.jpg" alt="Random" />
			<div class="btn-container"><button class="gray-large">Random</button></div>
		</li>
		<li class="Scary">
			<img src="/img/halloween/style-woman-scary.jpg" alt="Scary" />
			<div class="btn-container"><button class="gray-large">Scary</button></div>
		</li>
		<li class="Role">
			<img src="/img/halloween/style-woman-occupation.jpg" alt="Role" />
			<div class="btn-container"><button class="gray-large">Role</button></div>
		</li>
		<li class="Sexy">
			<img src="/img/halloween/style-woman-sexy.jpg" alt="Sexy" />
			<div class="btn-container"><button class="gray-large">Sexy</button></div>
		</li>
        <li class="Movie">
			<img src="/img/halloween/style-woman-movie.jpg" alt="Movie" />
			<div class="btn-container"><button class="gray-large">Movie</button></div>
		</li>
        <li class="Funny">
			<img src="/img/halloween/style-woman-funny.jpg" alt="Funny" />
			<div class="btn-container"><button class="gray-large">Funny</button></div>
		</li>
		<div class="clear"></div>
	</ul>
</div>

<div id="mens-styles-cont">
	<h1>Choose your style</h1> 
	<ul class="style-choices" id="mens-styles">
		<li class="All">
			<img src="/img/man-1.jpg" alt="All Brands" />
			<div class="btn-container"><button class="gray-large">All Brands</button></div>
		</li>
		<li class="Random">
			<img src="/img/halloween/style-man-random.jpg" alt="Random" />
			<div class="btn-container"><button class="gray-large">Random</button></div>
		</li>
		<li class="Scary">
			<img src="/img/halloween/style-man-scary.jpg" alt="Scary" />
			<div class="btn-container"><button class="gray-large">Scary</button></div>
		</li>
		<li class="Role">
			<img src="/img/halloween/style-man-occupation.jpg" alt="Role" />
			<div class="btn-container"><button class="gray-large">Role</button></div>
		</li>
		<li class="Movie">
			<img src="/img/halloween/style-man-movie.jpg" alt="Movie" />
			<div class="btn-container"><button class="gray-large">Movie</button></div>
		</li>
		<li class="Funny">
			<img src="/img/halloween/style-man-funny.jpg" alt="Funny" />
			<div class="btn-container"><button class="gray-large">Funny</button></div>
		</li>
		<div class="clear"></div>
	</ul>
</div>

<div id="lightbox-gender">
	<h2>PICK ONE.</h2>
	<div class="gender-option female"></div>
	<div class="gender-option male"></div>
</div>
<div id="lightbox-product">
	<div class="close" id="lp-close"></div>
	<div class="lp-img-full"><a href="" target="_blank"><img src="" alt="test" /></a></div>
	<div class="lp-content-right">
		<div class="lp-name"></div>
		<div class="lp-brand"></div>
		<div class="lp-price-cont">
			<div class="lp-price-left"></div>
			<div class="lp-price"></div>
			<div class="clear"></div>
		</div>
		<p class="lp-desc"></p>
		<a href="" target="_blank"><button class="lp-buy">BUY IT</button></a>
	</div>
	<div id="lp-comments"></div>
</div>
<div id="lightbox-subscribe">
    <div class="close" id="ls-close"></div>
    <h2>More styles coming soon</h2>
    <h3>Find out about the newest styles first</h3>
    <img src="/img/subscribe-splash.jpg" style="margin-bottom:10px" />
    <!-- Begin MailChimp Signup Form -->
    <link href="http://cdn-images.mailchimp.com/embedcode/classic-081711.css" rel="stylesheet" type="text/css">
    <style type="text/css">
        #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
        /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
           We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
    </style>
    <div id="mc_embed_signup">
    <form action="http://99styles.us6.list-manage2.com/subscribe/post?u=22414ed999f40edcc43d33e05&amp;id=c96514de74" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div class="mc-field-group">
        <input placeholder="email address" type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
    </div>
        <div id="mce-responses" class="clear">
            <div class="response" id="mce-error-response" style="display:none"></div>
            <div class="response" id="mce-success-response" style="display:none"></div>
        </div>  <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </form>
    </div>
    <!--End mc_embed_signup-->
</div><!-- #lightbox-subscribe -->
<div id="dimmer"></div>
<div id="styles-btn" class="<?php if( !empty($_SESSION['user']['gender']) ){ switch( $_SESSION['user']['gender']){ case 'm': echo 'male-style';break; case 'f': echo 'female-style';break; } } ?>"></div>
<div id="back-btn" class="hide">BACK</div>
<nav style="visibility: hidden;">
    <?php echo $this->pager($this->products->pager(), 'partials/pager/pager_custom.phtml'); ?>
</nav>
<script type="text/javascript">
	var app = {
	    user: <?php if( !empty($_SESSION['user']) ){ echo json_encode($_SESSION['user']); }else{ echo "{}"; } ?>,
            skip_wizard: <?php echo ($this->skip_wizard)? $this->skip_wizard: 0; ?>,
            productPage: 0,
            type_fitlers: '',
	    init: function(){
                this.type_filters = $('#type_filter');
                if( this.skip_wizard ){
	            this.hide_wizard();
	            //this.update_products();
                    //this.endless_scroll();
                    this.infinite_scroll();
                }else if( this.user.gender !== undefined && this.user.style !== undefined ){
                    this.hide_wizard();
                    //this.update_products();
                    //this.endless_scroll();
                    this.infinite_scroll();
                }
                $('body').css('visibility','visible');
                $('.indicator').hide();
	    },
            hide_wizard: function(){
                $('#search-bar').show();
                $('#dimmer').hide();
                $('#lightbox-gender').hide();
                $('#splash').hide();
                $('.indicator').show();

                $('#search-bar').show();
                $('.indicator').show();
                $('#type_filter').show();
                $('#styles-btn').show();
                $('#back-btn').removeClass('hide');
            },
            update_products: function(){
                var t = this;
                $('#products').infinitescroll({
                    state: {
                        currPage: 1
                    }
                });
                $.ajax({
                    url: '/api/products',
                    type: 'post',
                    data: { 'page': this.productPage },
                    success: function(res){
                        var $container = $('#products');
                        $container.html(res.result.html).show().css({visibility:'hidden'});
                         $container.imagesLoaded(function(){
                            $('.indicator').hide();
                            $container.masonry('reload').css({visibility:'visible'});
                            $('#styles-btn').show();
                            $('#back-btn').removeClass('hide');
                            $('#type_filter').show();
                            
                         });
                    }
                });
                $.get('/api/get-user', function(res){
                    t.active_filters = $('#active-filters');
                    t.active_filters.html('');
                    
                    $(res.result.brands).each( function(k,v){
                        t.add_brand(v);
                    });
                    
                    t.type_filters = $('#type_filter');
                    t.type_filters.html('');
                    res.result.availableStyles.unshift('All');
                    $(res.result.availableStyles).each( function(k,v){
                        t.add_filter_type(v,res.result.style);
                    });
                }, 'json');
            },
            endless_scroll: function(){
                var t = this;
            
                $(document).endlessScroll({
                  inflowPixels: 100,
                  fireDelay: true,
                  ceaseFireOnEmpty: false,
                  loader: '<div class="indicator"></div>',
                  callback: function(i, x, direction) {
                    if (direction == 'prev') {
                        return false;
                    } else {
                        t.productPage++
                        $('.indicator').show();
                        t.append_products();
                        if (t.productPage == 2) {
                            $('#lightbox-subscribe,#dimmer').show();
                        }
                    }
                  }
                });
            },
            infinite_scroll: function(){
                var $products = $('#products');
                $products.infinitescroll({
                    navSelector  : "nav",            
                    nextSelector : "nav a:last",    
                    itemSelector : "#products li",
                    debug : false,
                    dataType : 'html',
                    prefill : false,
                    animate: true,
                    extraScrollPx: 100,
                    bufferPx: 100,
                    state: {
                        isDuringAjax: false,
                        isInvalidPage: false,
                        isDestroyed: false,
                        isDone: false, // For when it goes all the way through the archive.
                        isPaused: false,
                        currPage: <?php echo ( $this->params('page') ? $this->params('page'): 1 ); ?>
                    },
                    loading: {
                        finishedMsg: 'No more pages to load.',
                        img: 'http://i.imgur.com/6RMhx.gif'
                    }
                }, function(newElements){
                    var $newElems = $( newElements ).css({ opacity: 0 });
                    $newElems.imagesLoaded(function(){
                        // show elems now they're ready
                        $newElems.animate({ opacity: 1 });
                        $products.masonry( 'appended', $newElems, true ); 
                    });
                });
            },
            append_products: function(){
                $.ajax({
                    url: '/api/products',
                    type: 'post',
                    data: { 'page': this.productPage },
                    success: function(res){
                        var $container = $('#products');
                        //$container.append(res.result.html).show().css({visibility:'hidden'});
                        $html = $(res.result.html);
                        $html.css('visibility','hidden');
                        $container.append($html);
                         $container.imagesLoaded(function(){
                            $html.css('visibility','visible');
                            $('.indicator').hide();
                            $container.masonry('appended', $html);
                            $('#styles-btn').show();
                            $('#back-btn').removeClass('hide');
                            $('#type_filter').show();
                            
                         });
                    }
                });
            },
            add_filter_type: function(type, user_type){
                if(user_type == type){
                    hit = 'class="hit"';
                }else{
                    hit = '';
                }
                html = '<a href="#"' + hit + '>' + type + '</a>';
                this.type_filters.append(html);
            },
            add_brand: function(brand){
                $active_filters = $('#active-filters');
                html = '<li class="' + brand + '"><span class="close"></span>' + brand + '</li>';
                $active_filters.append(html);
            },
            set_gender: function(gender){
                switch(gender){
                    case 'f': $('#styles-btn').addClass('female-style').removeClass('male-style');break;
                    case 'm': $('#styles-btn').addClass('male-style').removeClass('female-style');break;
                    default: break;
                }
            }
	}
</script>